<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>设备管理</title>
		<link rel="stylesheet" href="./demo.css" />
		<style></style>
	</head>
	<body>
		<div id="indoorMap"></div>
		<div
			id="loading"
			class="btn-default"
			style="position: absolute; left: 0; top: 0; right: 0; bottom: 0; width: 100px; height: 30px; margin: auto"
		>
			加载中···
		</div>
		<div style="position: absolute; left: 10px; top: 10px">
			<span id="backZoneButton" style="display: none; cursor: pointer">园区</span>
			<span id="crumb"></span>
		</div>

		<div style="position: absolute; right: 10px; top: 130px; z-index: 99">
			<div class="deviceFormBox cursor">
				<div id="addDeviceBtn">
					<div id="addDeviceBtnIcon">+</div>
					<div id="addDeviceBtnText">添加设备</div>
				</div>
				<div id="addDeviceBox">
					<form id="addDeviceForm">
						<div>
							<span>设备序列号：</span
							><select name="deviceId" value=""></select>
						</div>
						<div><span>设备名称：</span><input type="text" name="name" readonly /></div>
						<div><span>设备类型：</span><input type="text" name="type" readonly /></div>
						<div>
							<span>坐标: </span><input type="text" name="coordinate" />
							<button id="pickCoorBtn">选择</button>
						</div>

						<button type="submit" id="submitAddDevice">提交</button>
					</form>
				</div>
				<div style="clear: both"></div>
			</div>

			<div id="floorSwitch" class="cursor">
				<div id="showAllFloor"></div>
				<div id="floorList">
					<div>F2</div>
					<div>F1</div>
				</div>
			</div>

			<div style="clear: both"></div>

			<div id="modeSwitch" class="cursor">2D</div>
		</div>

		<style>
			.cursor {
				cursor: pointer;
			}
			#floorSwitch {
				float: right;
				width: 42px;
				color: #999;
				text-align: center;
				background-color: #fff;
				margin-top: 20px;
				margin-bottom: 20px;
				border-radius: 4px;
			}
			#showAllFloor {
				display: inline-block;
				width: 32px;
				height: 26px;
				margin: 6px 6px 2px;
				background: url('./floorSwitch.png') 0 0 no-repeat;
				background-position: center 2px;
			}
			#floorSwitch #floorList {
				display: none;
			}
			#floorSwitch #floorList div {
				width: 42px;
				height: 36px;
				line-height: 36px;
				border-top: 1px solid #ddd;
			}
			.currentFloor {
				color: rgb(24, 144, 255);
			}
			.deviceFormBox {
				border-radius: 4px;
				background-color: #fff;
			}
			#addDeviceBtn {
				float: right;
				font-size: 14px;
				width: 42px;
				padding: 5px;
				color: rgb(24, 144, 255);
				text-align: center;
			}
			#addDeviceBtnIcon {
				margin: 0 auto;
				width: 24px;
				height: 24px;
				line-height: 20px;
				font-size: 20px;
				border: 1px solid rgb(24, 144, 255);
				border-radius: 12px;
			}

			#addDeviceBox {
				float: left;
				display: none;
				border-right: 1px solid #ddd;
				padding: 15px 20px;
			}

			#addDeviceForm div {
				height: 30px;
				margin-top: 10px;
				line-height: 30px;
			}
			#addDeviceForm span {
				display: inline-block;
				width: 100px;
			}
			#addDeviceForm select,
			#addDeviceForm input {
				display: inline-block;
				width: 150px;
				height: 24px;
				border: 1px solid #ddd;
				outline: none;
			}
			#addDeviceForm input[name='coordinate'] {
				width: 105px;
			}
			#pickCoorBtn {
				height: 24px;
				vertical-align: middle;
				outline: none;
				border: 1px solid #ddd;
				cursor: pointer;
			}
			#submitAddDevice {
				margin-top: 20px;
				margin-left: 100px;
				font-size: 16px;
				width: 80px;
				height: 30px;
				outline: none;
				border: 1px solid #ddd;
				color: #fff;
				background-color: rgb(24, 144, 255);
				border-radius: 2px;
				cursor: pointer;
			}

			#modeSwitch {
				float: right;
				font-size: 14px;
				width: 42px;
				height: 36px;
				line-height: 26px;
				padding: 5px;
				color: rgb(24, 144, 255);
				text-align: center;
				background: #fff;
				border-radius: 4px;
			}

			#table-container button {
				outline: none;
				border: 1px solid #ddd;
				cursor: pointer;
			}
		</style>

		<div id="table-container">
			<table class="table table-bordered table-hover" id="table">
				<thead>
					<tr>
						<th>编号</th>
						<th>设备序列号</th>
						<th>设备名称</th>
						<th>设备类型</th>
						<th>楼栋名</th>
						<th>楼层名</th>
						<th>坐标</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody id="table-body"></tbody>
			</table>
		</div>
		<div style="position: absolute; right: 200px; top: 10px" id="legendBox"></div>
		<script src="./AirocovMap.js"></script>
		<script>
			// 未绑定位置设备列表
			var unboundDevice = [
				{
					deviceId: 'A-1',
					name: '设备3',
					type: 0,
				},
				{
					deviceId: 'B-1',
					name: '设备4',
					type: 1,
				},
				{
					deviceId: 'C-1',
					name: '设备5',
					type: 2,
				},
				{
					deviceId: 'C-2',
					name: '设备6',
					type: 2,
				},
			];
			// 已绑定位置设备列表
			var boundDevice = [
				{
					id: 0,
					deviceId: 'A-0',
					name: '设备0',
					type: 0,
					coordinate: [2, 2],
				},
				{
					id: 1,
					deviceId: 'B-0',
					name: '设备1',
					type: 1,
					buildingName: '美术馆',
					floorName: 'F1',
					coordinate: [1, 1],
				},
				{
					id: 2,
					deviceId: 'C-0',
					name: '设备2',
					type: 2,
					buildingName: '美术馆',
					floorName: 'F2',
					coordinate: [-1, -1],
				},
			];
			// 配置选项
			var options = {
				deviceType: {
					0: {
						name: '人体感应器',
						icon: './3.png',
					},
					1: {
						name: '智能控灯设备',
						icon: './1.png',
					},
					2: {
						name: '环境传感器',
						icon: './2.png',
					},
				},
				deviceSize: 32,
				normalColor: '#000',
				activeColor: '#00F',
				backgroundColor: '#0F3C51',
			};
		</script>
		<script>
			window.onload = function () {
				var devices = new Map();
				var backZoneButton = document.getElementById('backZoneButton'),
					crumb = document.getElementById('crumb'),
					deviceFormBox = document.getElementById('deviceFormBox'),
					addDeviceBtn = document.getElementById('addDeviceBtn'),
					addDeviceBtnText = document.getElementById('addDeviceBtnText'),
					addDeviceBtnIcon = document.getElementById('addDeviceBtnIcon'),
					addDeviceBox = document.getElementById('addDeviceBox'),
					modeSwitch = document.getElementById('modeSwitch'),
					showAllFloor = document.getElementById('showAllFloor'),
					floorList = document.getElementById('floorList'),
					submitAddDevice = document.getElementById('submitAddDevice'),
					alterDeviceBox = document.getElementById('alterDeviceBox'),
					addDeviceForm = document.getElementById('addDeviceForm'),
					pickCoorBtn = document.getElementById('pickCoorBtn'),
					legendBox = document.getElementById('legendBox');
				var activeDeviceMarker = null;

				var OPERATION_STATE = {
					NONE: -1,
					ADD: 0,
					ALTER: 1,
				};

				var STATE = {
					DEVICE_OPERATION: OPERATION_STATE.NONE,
					SET_POSITION: false,
				};

				// 初始化地图
				var map = new AirocovMap.Map({
					container: document.getElementById('indoorMap'),
					mapUrl: ['./outdoor.acmap', './indoor.acmap'],
					themeUrl: './theme.json',
					floorSwitch: {
						show: false,
					},
					onReady() {
						console.log(map);
						document.getElementById('loading').remove();
						fillTableData(boundDevice.filter(item => !item.buildingName));
					},
				});

				Object.values(options.deviceType).forEach(typeItem => {
					legendBox.innerHTML += `<span class="legendRow">
												<i class="iconDel" style="background-image: url('${typeItem.icon}');background-color: ${options.backgroundColor}"></i>
												<span style="vertical-align: middle">${typeItem.name}</span>
											</span>`;
				});

				showAllFloor.onclick = function () {
					console.log(map.state, map.config.mapConfig.showAllFloor);
					if (map.state === 1) {
						map.showOneFloor();
					} else if (map.state === 2) {
						map.showAllFloor();
					}
				};
				floorList.onclick = function (e) {
					map.showOneFloor(e.target.innerText);
				};
				backZoneButton.onclick = function () {
					map.showMap();
				};
				// 2/3D切换按钮点击事件
				modeSwitch.onclick = function (e) {
					if (modeSwitch.innerText === '2D') {
						map.changeMode('2D');
						modeSwitch.innerText = '2D';
					} else if (modeSwitch.innerText === '3D') {
						map.changeMode('3D');
						modeSwitch.innerText = '3D';
					}
				};

				map.event.on('changeMode', e => {
					modeSwitch.innerText = e.mode === '2D' ? '3D' : '2D';
				});

				// 点击添加设备按钮， 显示添加设备表单
				addDeviceBtn.onclick = function () {
					if (!map.currentFloor) return alert('请先选择楼层！');

					if (addDeviceBox.style.display === 'block') {
						cancelAddDevice();
						return;
					}

					addDeviceBox.style.display = 'block';
					pickCoorBtn.style.display = 'inline-block';
					addDeviceBtnText.innerHTML = '添加设备';
					addDeviceBtnIcon.innerHTML = '-';
					addDeviceForm.deviceId.innerHTML = '<option value="">请选择设备</option>';
					unboundDevice.forEach((device, i) => {
						addDeviceForm.deviceId.innerHTML += `<option value='${i}' >${device.deviceId}</option>`;
					});

					STATE.DEVICE_OPERATION = OPERATION_STATE.ADD;
				};
				// 切换设备序列号时，更新设备类型字段
				addDeviceForm.deviceId.onchange = function (e) {
					if (!this.value) {
						addDeviceForm.name.value = '';
						addDeviceForm.type.value = '';
					} else {
						addDeviceForm.name.value = unboundDevice[this.value].name;
						addDeviceForm.type.value = options.deviceType[unboundDevice[this.value].type].name;
					}
				};

				// 点击选择位置按钮，进入设置位置状态，并切换地图模式至2D
				pickCoorBtn.onclick = function (e) {
					e.preventDefault();

					if (!addDeviceForm.deviceId.value) {
						return alert('请选择设备！');
					}

					if (STATE.SET_POSITION) return;

					map.changeMode('2D');

					map.dom.classList.add('customCursor');
					map.clickIntoBuilding = false; // 阻止室外点击到楼栋时进入室内
					STATE.SET_POSITION = true;
				};

				submitAddDevice.onclick = function (e) {
					e.preventDefault();

					if (!addDeviceForm.deviceId.value || !addDeviceForm.type.value) {
						return alert('请选择设备！');
					}

					if (!addDeviceForm.coordinate.value) {
						return alert('请选择设备位置！');
					}
					var coordinate = addDeviceForm.coordinate.value.split(',');
					coordinate = [Number(coordinate[0]), Number(coordinate[1])];

					if (STATE.DEVICE_OPERATION === OPERATION_STATE.ADD) {
						boundDevice.push({
							id: boundDevice[boundDevice.length - 1].id + 1,
							deviceId: unboundDevice[addDeviceForm.deviceId.value].deviceId,
							name: addDeviceForm.name.value,
							type: unboundDevice[addDeviceForm.deviceId.value].type,
							coordinate,
							buildingName: map.currentBuilding ? map.currentBuilding.name : null,
							floorName: map.currentBuilding && map.currentFloor ? map.currentFloor.name : null,
						});

						unboundDevice.splice(addDeviceForm.deviceId.value, 1);

						alert('添加成功！');
						endAddDevice();

						render({ building: map.currentBuilding, floor: map.currentFloor });
					} else if (STATE.DEVICE_OPERATION === OPERATION_STATE.ALTER) {
						activeDeviceMarker.info.userData.coordinate = coordinate;
						boundDevice.find(item => item.id === activeDeviceMarker.info.userData.id).coordinate =
							coordinate;
						alert('修改成功！');
						cancelAddDevice();
					}
				};

				function cancelAddDevice() {
					addDeviceBox.style.display = 'none';
					addDeviceBtnText.innerHTML = '添加设备';
					addDeviceBtnIcon.innerHTML = '+';
					if (STATE.DEVICE_OPERATION === OPERATION_STATE.ADD && activeDeviceMarker) {
						activeDeviceMarker.remove();
						devices.delete(activeDeviceMarker.info.userData.id);
						activeDeviceMarker = null;
					} else if (STATE.DEVICE_OPERATION === OPERATION_STATE.ALTER) {
						activeDeviceMarker.position.x = activeDeviceMarker.info.userData.coordinate[0];
						activeDeviceMarker.position.z = activeDeviceMarker.info.userData.coordinate[1];
					}

					endAddDevice();
				}

				function endAddDevice() {
					map.dom.classList.remove('customCursor');
					map.changeMode('3D');

					resetFocusMarker();
					addDeviceForm.reset();
					map.clickIntoBuilding = true;
					STATE.DEVICE_OPERATION = OPERATION_STATE.NONE;
					STATE.SET_POSITION = false;
				}

				map.event.on('changeMap', changeCrumb);
				map.event.on('changeMap', render);
				map.event.on('changeMap', () => {
					// 切换地图时(单楼层到多楼层时)，如果有正在修改的设备，则恢复其位置
					if (STATE.DEVICE_OPERATION === OPERATION_STATE.ALTER) {
						activeDeviceMarker.position.x = activeDeviceMarker.info.userData.coordinate[0];
						activeDeviceMarker.position.z = activeDeviceMarker.info.userData.coordinate[1];
					}

					addDeviceBox.style.display = 'none';
					addDeviceBtn.style.display = 'block';
					addDeviceBtnText.innerHTML = '添加设备';
					addDeviceBtnIcon.innerHTML = '+';

					endAddDevice();
				});
				map.event.on('click', handleDefaultClick);

				function handleDefaultClick(e) {
					console.log(e);

					//监控管理页, 设置摄像头位置时, 点击添加/修改摄像头位置
					if (STATE.SET_POSITION) {
						addDeviceForm.coordinate.value =
							Number(e.position.x.toFixed(2)) + ',' + Number(e.position.z.toFixed(2));

						if (activeDeviceMarker) {
							activeDeviceMarker.position.x = e.position.x;
							activeDeviceMarker.position.z = e.position.z;
						} else {
							addMarker(
								{
									id: boundDevice[boundDevice.length - 1].id + 1,
									deviceId: unboundDevice[addDeviceForm.deviceId.value].deviceId,
									name: addDeviceForm.name.value,
									type: unboundDevice[addDeviceForm.deviceId.value].type,
									coordinate: [Number(e.position.x.toFixed(2)), Number(e.position.z.toFixed(2))],
									buildingName: map.currentBuilding ? map.currentBuilding.name : null,
									floorName: map.currentFloor.name,
								},
								marker => {
									activeDeviceMarker = marker;
									activeDeviceMarker.setColor(options.activeColor);
								}
							);
						}
					} else if (e.target.name === 'device') {
						alterDevice(e.target.info.userData);
					}
				}

				// 切换地图时，修改左上角位置信息
				function changeCrumb({ building, floor }) {
					console.log(floor);
					if (building) {
						if (floor) {
							crumb.innerHTML = ' > ' + building.name + '-' + floor.name;

							let currentFloor = document.querySelector('.currentFloor');
							if (currentFloor) {
								currentFloor.classList.remove('currentFloor');
							}
							for (let i = 0; i < floorList.children.length; i++) {
								if (floorList.children[i].innerText === floor.name) {
									floorList.children[i].classList.add('currentFloor');
									break;
								}
							}
							showAllFloor.style.backgroundPositionY = '2px';
						} else {
							crumb.innerHTML = ' > ' + building.name;
							let currentFloor = document.querySelector('.currentFloor');
							if (currentFloor) {
								currentFloor.classList.remove('currentFloor');
							}
							showAllFloor.style.backgroundPositionY = '-25px';
						}
						backZoneButton.style.display = 'inline-block';
						floorList.style.display = 'block';
					} else {
						crumb.innerHTML = '';
						backZoneButton.style.display = 'none';
						floorList.style.display = 'none';
						showAllFloor.style.backgroundPositionY = '2px';
					}
				}

				//切换地图时, 清除设备图标，并绘制显示楼层的设备图标
				function render({ building, floor }) {
					clearHiddenDevices();

					if (!floor) {
						// 多楼层
						fillTableData(boundDevice.filter(item => item.buildingName === map.currentBuilding.name));
					} else {
						// 室外或室内单楼层
						fillTableData(
							boundDevice.filter(
								item =>
									(!building && !item.buildingName) ||
									(building && building.name === item.buildingName && floor.name === item.floorName)
							)
						);
					}
				}

				// 清除隐藏的图标
				function clearHiddenDevices() {
					devices.forEach(device => {
						if (device.parent && device.parent.parent.visible && device.parent.visible) return;
						device.remove();
						devices.delete(device.info.userData.id);
					});
				}

				//填充表格数据
				function fillTableData(boundDevice) {
					var oTable = document.querySelector('#table');
					var oTableBody = document.querySelector('#table-body');
					var aTr = oTable.getElementsByTagName('tr');
					oTableBody.innerHTML = '';
					var tr = '';

					boundDevice.forEach((model, i) => {
						addMarker(model);
						var deviceInfo = JSON.stringify(model);
						tr += `<tr class="${
							i % 2 == 1 ? 'active' : 'bg-success'
						}" boundDevice-model='${deviceInfo}'><td>
								${model.id}
								</td><td>
								${model.deviceId}
								</td><td>
								${model.name}
								</td><td>
								${options.deviceType[model.type].name}
								</td><td>
								${model.buildingName || '室外'}
								</td><td>
								${model.floorName || '-'}
								</td><td>
								${model.coordinate || '-'}
								</td><td>
									<button boundDevice-model='${deviceInfo}'>修改位置</button>
									<button boundDevice-model='${deviceInfo}'>删除</button>
								</td>
								</tr>`;
					});
					oTableBody.innerHTML = tr;

					//点击某一行数据联动
					Array.from(aTr).forEach((item, i) => {
						if (i === 0) return;

						var deviceInfo = JSON.parse(item.getAttribute('boundDevice-model'));
						item.onclick = function (e) {
							if (!map.currentFloor) {
								// 显示多楼层时，需要切换地图
								map.showMap({
									buildingName: deviceInfo.buildingName,
									floorName: deviceInfo.floorName,
									onComplete: () => {
										moveToDevice(deviceInfo);
									},
								});
							} else {
								moveToDevice(deviceInfo);
							}
						};

						var btns = item.cells[item.cells.length - 1].children;
						Array.from(btns).forEach((btn, j) => {
							btn.onclick =
								j === 0
									? e => {
											e.stopPropagation();
											alterDevice(JSON.parse(e.target.getAttribute('boundDevice-model')));
									  }
									: deleteDevice;
						});
					});
				}

				// 视角切换至目标设备
				function moveToDevice(deviceInfo, callback) {
					var buildingCenter = map.currentBuilding
						? [map.currentBuilding.position.x, map.currentBuilding.position.z]
						: [0, 0];
					map.panTo(
						{
							x: deviceInfo.coordinate[0] + buildingCenter[0],
							y: 1 + map.currentFloor.position.y,
							z: deviceInfo.coordinate[1] + buildingCenter[1],
						},
						callback
					);

					resetFocusMarker();
					activeDeviceMarker = devices.get(deviceInfo.id);
					activeDeviceMarker.setColor(options.activeColor);
				}

				// 开始修改设备位置
				function alterDevice(deviceInfo) {
					if (!map.currentFloor) {
						// 显示多楼层时，需要切换地图
						map.showMap({
							buildingName: deviceInfo.buildingName,
							floorName: deviceInfo.floorName,
							onComplete: () => {
								moveToDevice(deviceInfo, () => {
									setTimeout(() => {
										map.changeMode('2D');
									}, 100);
								});
							},
						});
					} else {
						moveToDevice(deviceInfo, () => {
							setTimeout(() => {
								map.changeMode('2D');
							}, 100);
						});
					}

					addDeviceBox.style.display = 'block';
					addDeviceBtnText.innerHTML = '修改设备';
					addDeviceBtnIcon.innerHTML = '-';
					addDeviceForm.deviceId.innerHTML = `<option>${deviceInfo.deviceId}</option>`;
					addDeviceForm.name.value = deviceInfo.name;
					addDeviceForm.type.value = options.deviceType[deviceInfo.type].name;
					addDeviceForm.coordinate.value = deviceInfo.coordinate.toString();

					map.clickIntoBuilding = false;
					STATE.DEVICE_OPERATION = OPERATION_STATE.ALTER;
				}
				// 删除设备
				function deleteDevice(e) {
					e.stopPropagation();
					var deviceInfo = JSON.parse(e.target.getAttribute('boundDevice-model'));

					if (confirm('是否删除该设备？')) {
						devices.get(deviceInfo.id).remove();
						devices.delete(deviceInfo.id);
						boundDevice = boundDevice.filter(item => item.id !== deviceInfo.id);
						render({ building: map.currentBuilding, floor: map.currentFloor });

						if (
							STATE.DEVICE_OPERATION === OPERATION_STATE.ALTER &&
							activeDeviceMarker.info.userData.id === deviceInfo.id
						) {
							// 如果当前正在修改该设备，则关闭右侧表单
							addDeviceBox.style.display = 'none';
							addDeviceBtn.style.display = 'block';

							endAddDevice();
						}
					}
				}

				//生成图片标注，并加入地图中
				function addMarker(deviceInfo, callback) {
					if (devices.get(deviceInfo.id)) return;

					new AirocovMap.covers.ImageMarker({
						name: 'device',
						imgSrc: options.deviceType[deviceInfo.type].icon,
						size: options.deviceSize,
						position: {
							x: deviceInfo.coordinate[0],
							y: 1,
							z: deviceInfo.coordinate[1],
						},
						userData: deviceInfo,
						canvasHeight: map.dom.offsetHeight,
						callback: function (marker) {
							// 保存设备图标到devices
							devices.set(deviceInfo.id, marker);
							// 设置图标颜色
							marker.setColor(options.normalColor);
							marker.material.depthTest = false;

							callback && callback(marker);
							// 图标加入地图中
							map.addToMap({
								object: marker,
								buildingName: deviceInfo.buildingName,
								floorName: deviceInfo.floorName,
								layerName: 'device',
								isClick: true, // 标记为可点击
							});
						},
					});
				}

				// 恢复聚焦图标颜色
				function resetFocusMarker() {
					activeDeviceMarker && activeDeviceMarker.setColor(options.normalColor);
					activeDeviceMarker = null;
				}
			};
		</script>
	</body>
</html>
